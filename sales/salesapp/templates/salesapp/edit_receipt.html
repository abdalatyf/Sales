{% extends 'salesapp/base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<form method="POST" action="{% url 'edit_receipt' receipt.id %}" id="receipt-form">
    {% csrf_token %}

    {% if error_message %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    {% if success_message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4" id="customer-section">
                <div class="card-header">
                    <h2 class="h5 mb-0">1. بيانات العميل</h2>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="customer_name" class="form-label">اسم العميل <span id="customer-name-required"
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customer_name" name="customer_name"
                                value="{{ receipt.customer_name }}">
                        </div>
                        <div class="col-md-6">
                            <label for="phone_number" class="form-label">رقم الهاتف <i
                                    class="bi bi-exclamation-triangle-fill text-warning" id="phone-warning"
                                    title="اختياري"></i></label>
                            <input type="text" class="form-control arabic-numerals" id="phone_number"
                                name="phone_number" value="{{ receipt.phone_number }}">
                        </div>
                        <div class="col-md-6">
                            <label for="address" class="form-label">العنوان</label>
                            <input type="text" class="form-control arabic-numerals" id="address" name="address"
                                value="{{ receipt.address }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="h5 mb-0">2. المنتجات المباعة <span class="text-danger">*</span></h2>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="row g-3 align-items-end mb-3 flex-shrink-0" id="add-item-row">
                        <div class="col-md-5">
                            <label for="product_search" class="form-label">ابحث عن المنتج</label>
                            <input class="form-control form-control-sm" list="product-list-options" id="product_search"
                                placeholder="اكتب للبحث...">
                            <datalist id="product-list-options">
                                {% for product in products %}
                                <option value="{{ product.name }}" data-product-id="{{ product.id }}"
                                    data-max="{{ product.quantity }}" data-name="{{ product.name }}">
                                    (متاح: {{ product.quantity }})
                                </option>
                                {% endfor %}
                            </datalist>
                            <div id="product-search-error" class="text-danger mt-1 d-none small">الرجاء اختيار منتج
                                موجود من القائمة.</div>
                        </div>
                        <div class="col-md-2">
                            <label for="item_quantity" class="form-label">الكمية</label>
                            <input type="number" class="form-control form-control-sm arabic-numerals" id="item_quantity"
                                min="1" value="1">
                        </div>
                        <div class="col-md-3">
                            <label for="item_price" class="form-label">سعر الوحدة</label>
                            <input type="number" class="form-control form-control-sm arabic-numerals" id="item_price"
                                min="0" value="0">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-info btn-sm w-100" id="add-item-btn">إضافة</button>
                        </div>
                    </div>

                    <div class="flex-grow-1" style="overflow-y: auto; max-height: 250px;">
                        <table class="table table-bordered table-sm" id="items-table">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>المنتج</th>
                                    <th class="text-center">كمية</th>
                                    <th class="text-center">سعر</th>
                                    <th class="text-center">إجمالي</th>
                                    <th class="text-center">حذف</th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body"></tbody>
                        </table>
                    </div>
                    <div class="flex-shrink-0 fw-bold fs-5 mt-2">
                        <div class="row">
                            <div class="col text-end border-top pt-2">الإجمالي الكلي:</div>
                            <div class="col-auto text-center border-top pt-2" id="total-amount-display"
                                style="min-width: 80px;">0</div>
                            <div class="col-auto" style="width: 50px;"></div>
                        </div>
                    </div>
                    <input type="hidden" name="sale_items_json" id="sale_items_json"
                        value="{{ sale_items_json_str|escape }}">
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm mb-4" id="payment-section">
                <div class="card-header">
                    <h2 class="h5 mb-0">3. بيانات الدفع والحفظ</h2>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="row g-3 mb-3">
                        <div class="col-md-5">
                            <label for="down_payment" class="form-label">المقدم <i
                                    class="bi bi-exclamation-triangle-fill text-warning" id="downpayment-warning"
                                    title="اختياري, افتراضي 0"></i></label>
                            <input type="number" class="form-control arabic-numerals" id="down_payment"
                                name="down_payment" min="0" value="{{ receipt.down_payment }}">
                        </div>
                        <div class="col-md-7">
                            <label for="installment_system" class="form-label">وصف نظام القسط <span
                                    id="installment-required" class="text-danger">*</span></label>
                            <textarea class="form-control arabic-numerals" id="installment_system"
                                name="installment_system" rows="3">{{ receipt.installment_system }}</textarea>
                        </div>
                    </div>
                    <div class="mt-auto text-center pt-3">
                        <button type="submit" class="btn btn-success btn-lg px-5">تحديث الوصل</button>
                        <a href="{% url 'search_receipts' %}" class="btn btn-secondary btn-lg px-3 ms-2">إلغاء</a>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="h5 mb-0">4. المعلومات الأساسية</h2>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="receipt_number" class="form-label">رقم الوصل</label>
                            <input type="text" class="form-control" id="receipt_number" name="receipt_number"
                                value="{{ receipt.receipt_number }}" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="salesperson_id" class="form-label">المندوب (البائع) <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="salesperson_id" name="salesperson_id" required>
                                <option value="">-- اختر --</option>
                                {% for person in salespersons %}
                                <option value="{{ person.id }}" {% if receipt.salesperson_id==person.id %}selected{%
                                    endif %}>
                                    {{ person.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="area" class="form-label">المنطقة</label>
                            <input type="text" class="form-control arabic-numerals" id="area" name="area"
                                value="{{ receipt.area }}">
                        </div>
                        <div class="col-md-6 d-flex align-items-center justify-content-center pt-4">
                            <div class="form-check form-switch fs-5">
                                <input class="form-check-input" type="checkbox" role="switch" id="is_cash_sale"
                                    name="is_cash_sale" {% if receipt.is_cash_sale %}checked{% endif %}>
                                <label class="form-check-label" for="is_cash_sale">بيع كاش؟</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="sale_year" class="form-label">سنة البيع <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control arabic-numerals" id="sale_year" name="sale_year"
                                value="{{ receipt.sale_year }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="sale_month" class="form-label">شهر البيع <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control arabic-numerals" id="sale_month" name="sale_month"
                                value="{{ receipt.sale_month }}" min="1" max="12" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</form>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- تعريف العناصر ---
        const cashSaleCheckbox = document.getElementById('is_cash_sale');
        const customerSection = document.getElementById('customer-section');
        const paymentSection = document.getElementById('payment-section');
        const customerNameInput = document.getElementById('customer_name');
        const customerNameRequired = document.getElementById('customer-name-required');
        const installmentInput = document.getElementById('installment_system');
        const installmentRequired = document.getElementById('installment-required');
        const phoneWarning = document.getElementById('phone-warning');
        const downPaymentWarning = document.getElementById('downpayment-warning');

        const salespersonSelect = document.getElementById('salesperson_id');
        const productSearchInput = document.getElementById('product_search');
        const productListOptions = document.getElementById('product-list-options');
        const productSearchError = document.getElementById('product-search-error');

        const itemQuantityInput = document.getElementById('item_quantity');
        const itemPriceInput = document.getElementById('item_price');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemsTableBody = document.getElementById('items-table-body');
        const totalAmountDisplay = document.getElementById('total-amount-display');
        const saleItemsJsonInput = document.getElementById('sale_items_json');
        const receiptForm = document.getElementById('receipt-form');

        // --- تحميل المنتجات الحالية ---
        let saleItems = [];
        try {
            let initialJson = document.getElementById('sale_items_json').value.replace(/&quot;/g, '"');
            if (initialJson) {
                saleItems = JSON.parse(initialJson);
            }
        } catch (e) {
            console.error("خطأ في قراءة JSON المنتجات الحالية:", e);
            saleItems = [];
        }

        // --- وظائف مساعدة ---
        function calculateTotal() {
            let total = 0;
            saleItems.forEach(item => { total += item.quantity * item.price; });
            totalAmountDisplay.textContent = total;
            saleItemsJsonInput.value = JSON.stringify(saleItems);
        }

        function renderItemsTable() {
            itemsTableBody.innerHTML = '';
            saleItems.forEach((item, index) => {
                const row = document.createElement('tr');
                // التأكد من أن item.id هو string
                const itemIdStr = String(item.id);
                row.dataset.productId = itemIdStr;
                row.innerHTML = `
                    <td>[${itemIdStr}] ${item.name}</td>
                    <td class="text-center">${item.quantity}</td>
                    <td class="text-center">${item.price}</td>
                    <td class="text-center">${item.quantity * item.price}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm delete-item-btn" data-index="${index}">X</button>
                    </td>
                `;
                itemsTableBody.appendChild(row);
            });
            calculateTotal();
        }

        function toggleRequiredFields() {
            const isCash = cashSaleCheckbox.checked;
            customerSection.style.display = isCash ? 'none' : 'block';
            paymentSection.style.display = isCash ? 'none' : 'block';
            customerNameInput.required = !isCash;
            installmentInput.required = !isCash;
            customerNameRequired.style.display = isCash ? 'none' : 'inline';
            installmentRequired.style.display = isCash ? 'none' : 'inline';
            phoneWarning.style.display = 'inline';
            downPaymentWarning.style.display = 'inline';
        }

        function getSelectedProductData(searchValue) {
            for (let option of productListOptions.options) {
                if (option.value.trim() === searchValue.trim()) {
                    return {
                        id: option.dataset.productId,
                        name: option.dataset.name,
                        max: parseInt(option.dataset.max)
                    };
                }
            }
            return null;
        }

        // --- ربط الأحداث ---
        cashSaleCheckbox.addEventListener('change', toggleRequiredFields);
        toggleRequiredFields(); // التشغيل عند التحميل
        renderItemsTable(); // عرض المنتجات المحملة لأول مرة

        addItemBtn.addEventListener('click', function () {
            const searchValue = productSearchInput.value;
            const productData = getSelectedProductData(searchValue);

            if (!productData) {
                productSearchError.classList.remove('d-none');
                productSearchInput.focus();
                return;
            } else {
                productSearchError.classList.add('d-none');
            }

            const productId = productData.id;
            const productName = productData.name;
            const maxQuantity = productData.max;
            const quantityToAdd = parseInt(itemQuantityInput.value);
            const price = parseInt(itemPriceInput.value);

            if (isNaN(quantityToAdd) || quantityToAdd <= 0) { alert('كمية غير صحيحة.'); return; }
            if (isNaN(price) || price < 0) { alert('سعر غير صحيح.'); return; }

            const existingItemIndex = saleItems.findIndex(item => String(item.id) === productId); // مقارنة كنصوص
            let currentAddedQuantity = 0;
            if (existingItemIndex > -1) {
                currentAddedQuantity = saleItems[existingItemIndex].quantity;
            }

            // (ملاحظة: هذا التحقق من المخزون يحتاج تحسين لصفحة التعديل)
            // if (quantityToAdd + currentAddedQuantity > maxQuantity) {
            //     alert(`الكمية المطلوبة (${quantityToAdd + currentAddedQuantity}) أكبر من المتاح (${maxQuantity}).`);
            //     return;
            // }

            if (existingItemIndex > -1) {
                saleItems[existingItemIndex].quantity += quantityToAdd;
                saleItems[existingItemIndex].price = price;
            } else {
                saleItems.push({ id: productId, name: productName, quantity: quantityToAdd, price: price });
            }

            renderItemsTable();
            productSearchInput.value = '';
            itemQuantityInput.value = 1;
            itemPriceInput.value = 0;
            productSearchInput.focus();
        });

        productSearchInput.addEventListener('input', function () {
            productSearchError.classList.add('d-none');
        });

        itemsTableBody.addEventListener('click', function (event) {
            if (event.target.classList.contains('delete-item-btn')) {
                const indexToRemove = parseInt(event.target.dataset.index);
                saleItems.splice(indexToRemove, 1);
                renderItemsTable();
            }
        });

        receiptForm.addEventListener('submit', function (event) {
            if (saleItems.length === 0) {
                alert("يجب إضافة منتج واحد على الأقل.");
                event.preventDefault();
                return false;
            }
            saleItemsJsonInput.value = JSON.stringify(saleItems);
        });

        // --- (تم حذف كود تحديد المندوب، لأنه يتم بالـ DTL) ---
    });
</script>
{% endblock %}